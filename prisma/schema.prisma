// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  EMPLOYEE
  ADMIN
}

enum ReservationStatus {
  CONFIRMED
  PENDING
  CANCELLED
  RESCHEDULED
  CHECKED_IN
}

enum AuditActionType {
  CREATED
  CANCELLED
  MOVED
  CHECKED_IN
  MODIFIED
}

enum WaitingListStatus {
  PENDING
  NOTIFIED
  CONFIRMED
  EXPIRED
  CANCELLED
}

model User {
  id            String    @id @default(cuid())
  employeeId   String    @unique
  fullName      String
  email         String    @unique
  password      String?   // bcrypt hashed; optional during migration
  department    String?
  phoneNumber   String?
  role          UserRole  @default(EMPLOYEE)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  reservations  Reservation[]
  waitingList   WaitingList[]
  auditLogs     AuditLog[]

  @@index([employeeId])
  @@index([email])
}

model Reservation {
  id              String            @id @default(cuid())
  userId          String?
  employeeId      String?           // For public reservations
  employeeName    String?           // For public reservations
  email           String?           // For public reservations
  phoneNumber     String?           // Mobile number for SMS confirmation
  reservationDate DateTime
  seatCount       Int
  status          ReservationStatus @default(CONFIRMED)
  serialNumber    String            @unique
  qrCodeString    String
  creditsUsed     Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  user            User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLogs       AuditLog[]

  @@index([userId])
  @@index([employeeId])
  @@index([email])
  @@index([reservationDate])
  @@index([serialNumber])
  @@index([status])
}

model WaitingList {
  id                  String            @id @default(cuid())
  userId              String
  targetDate          DateTime
  requestedSeats      Int
  priorityScore       Int               @default(0)
  status              WaitingListStatus @default(PENDING)
  isNotified          Boolean           @default(false)
  notificationSentAt  DateTime?
  confirmationDeadline DateTime?
  confirmationToken    String?           @unique
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([targetDate])
  @@index([priorityScore])
  @@index([status])
}

model AuditLog {
  id              String          @id @default(cuid())
  reservationId   String?
  userId          String
  actionType      AuditActionType
  metadata        String?         // JSON string for additional data
  timestamp       DateTime        @default(now())

  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  reservation     Reservation?    @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([reservationId])
  @@index([actionType])
  @@index([timestamp])
}

model RiddleEpisode {
  id              String    @id @default(cuid())
  title           String
  description     String?
  youtubeUrl      String
  episodeNumber   Int       @unique
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  questions       RiddleQuestion[]
  answers         RiddleAnswer[]
  raffleSettings  RaffleSettings?
  raffleWinners   RaffleWinner[]

  @@index([episodeNumber])
  @@index([isActive])
}

model RiddleQuestion {
  id              String    @id @default(cuid())
  episodeId       String
  questionText    String
  optionA         String
  optionB         String
  optionC         String
  optionD         String
  correctAnswer   String    // "A", "B", "C", or "D"
  createdAt       DateTime  @default(now())

  episode         RiddleEpisode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  answers         RiddleAnswer[]

  @@index([episodeId])
}

model RiddleAnswer {
  id              String    @id @default(cuid())
  episodeId       String
  questionId      String
  employeeId      String
  employeeName    String
  email           String
  selectedAnswer  String    // "A", "B", "C", or "D"
  isCorrect       Boolean
  submittedAt     DateTime  @default(now())

  episode         RiddleEpisode @relation(fields: [episodeId], references: [id], onDelete: Cascade)
  question        RiddleQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([episodeId])
  @@index([questionId])
  @@index([employeeId])
  @@index([email])
}

model RaffleSettings {
  id              String    @id @default(cuid())
  episodeId       String    @unique
  numberOfWinners  Int       @default(1)
  isActive         Boolean   @default(false)
  raffleDate       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  episode         RiddleEpisode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@index([episodeId])
}

model RaffleWinner {
  id              String    @id @default(cuid())
  episodeId       String
  answerId        String?   // Reference to a correct answer submission
  employeeId      String
  employeeName    String
  email           String
  selectedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())

  episode         RiddleEpisode @relation(fields: [episodeId], references: [id], onDelete: Cascade)

  @@index([episodeId])
  @@index([employeeId])
  @@index([email])
}

model WellnessContent {
  id              String    @id @default(cuid())
  title           String
  content         String    @db.Text
  pdfUrl          String?
  displayOrder    Int       @default(0)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([displayOrder])
  @@index([isActive])
}
